# User–Capsule Relationship Architecture Pivot

**Status:** ✅ **Direction Update**
**Priority:** High
**Effort:** Low
**Impact:** High – Simplifies architecture and avoids unnecessary coupling

---

## Executive Summary

After reviewing our design for integrating Web2 (Neon) users with Web3 (ICP) capsules, we have determined that the proposed **user–capsule mapping** is **not necessary** for our MVP.

Capsules are **ICP-native objects**, tied to **principals**. The relationship between Web2 accounts and ICP principals is already managed through **Auth.js `accounts` table**. Attempting to force a direct coupling between `users.id` and `capsule.id` adds complexity without real benefit.

The **real integration point** is at the **memories and storage level**, where users may have content distributed between S3 (Web2) and ICP (Web3).

---

## Current Reality

### ICP Side

- A **Capsule** belongs to **one or more principals**.
- Capsule ownership and access control is enforced natively in ICP canisters.
- Capsule IDs are generated by the backend and live entirely in Web3.

### Neon Side

- `users` table represents Web2 identity.
- `accounts` table (Auth.js) links multiple providers (Google, II, etc.) to the same user.
- When a user links Internet Identity, their **principal** becomes associated with their existing Neon user.

### Key Point

Capsules do not need to be reflected in Neon. **They already belong to principals.**

---

## Why We Don't Need a Mapping Table

### Original Rationale

We considered a `userCapsules` table to explicitly connect `users.id` ↔ `capsule.id`.

### Updated Position

- **Redundant**: Capsule ownership is already defined by principal on ICP side.
- **Unnecessary duplication**: Neon doesn't need to store capsule IDs to know who owns them.
- **Coupling risk**: Forcing capsule IDs into Neon introduces sync risks and contradicts the principle of Web3-native ownership.
- **MVP focus**: This extra table adds migration and query complexity without business value.

---

## What Actually Matters

1. **Auth.js Account Linking**

   - The _only bridge_ we need is at the `accounts` table.
   - If a user signs in with Google and later links Internet Identity, both accounts resolve to the same Neon `userId`.
   - This ensures continuity across Web2 and Web3.

2. **Memory Storage Edges**

   - Integration happens at the level of **where memories are stored** (S3 vs ICP).
   - We already track this in Neon via storage edge metadata.
   - This is the place where Neon and ICP intersect, not in capsule IDs.

3. **Onboarding Flow**

   - Google-only users cannot create capsules.
   - If they want to create capsules, they must link II.
   - Once linked, their principal is recognized as an owner on ICP, and capsules can be created.

4. **Post-MVP Option**

   - We may later support merging standalone II accounts into existing Google accounts.
   - This remains an **Auth.js concern**, not a capsule concern.

---

## New Direction

1. **No `userCapsules` table** in Neon.
2. **Capsule IDs remain ICP-native** and not tied to Neon user IDs.
3. **Account linking via Auth.js** is the canonical bridge between Web2 and Web3.
4. **Focus integration on memories/storage edges**, where users may have data in both systems.
5. **Google-only users** → can use Web2 memories.
6. **Google + II users** → can also use ICP capsules and memories.

---

## Implementation Strategy

### Frontend Integration

```typescript
// Get user's principal from Auth.js session
const session = await auth();
const principal = session.user.icpPrincipal || session.user.linkedIcPrincipal;

if (principal) {
  // User has ICP access - can create/manage capsules
  const actor = await createActor({ principal });
  const capsules = await actor.capsules_list();
  // ... handle capsule operations
} else {
  // Google-only user - Web2 memories only
  // ... handle Web2-only flow
}
```

### Capsule Management

```typescript
// Create self-capsule (if user has principal)
const createSelfCapsule = async () => {
  const session = await auth();
  const principal = session.user.icpPrincipal;

  if (!principal) {
    throw new Error("Internet Identity required to create capsules");
  }

  const actor = await createActor({ principal });
  const capsule = await actor.capsules_create(); // Creates self-capsule
  return capsule;
};

// List user's capsules
const listUserCapsules = async () => {
  const session = await auth();
  const principal = session.user.icpPrincipal;

  if (!principal) return [];

  const actor = await createActor({ principal });
  return await actor.capsules_list();
};
```

### Memory Storage Integration

```typescript
// Check where memories are stored
const getMemoryStorage = async (memoryId: string) => {
  // Check Neon for Web2 memories
  const neonMemory = await db.query.memories.findFirst({
    where: eq(memories.id, memoryId),
  });

  if (neonMemory) {
    return { location: "neon", memory: neonMemory };
  }

  // Check ICP for Web3 memories
  const session = await auth();
  const principal = session.user.icpPrincipal;

  if (principal) {
    const actor = await createActor({ principal });
    const capsules = await actor.capsules_list();

    for (const capsule of capsules) {
      const fullCapsule = await actor.capsules_read(capsule.id);
      if (fullCapsule.memories.has(memoryId)) {
        return { location: "icp", memory: fullCapsule.memories.get(memoryId) };
      }
    }
  }

  return null;
};
```

---

## Benefits of This Approach

### ✅ **Simplified Architecture**

- No unnecessary mapping tables
- No sync complexity between systems
- Clean separation of concerns

### ✅ **Web3-Native Design**

- Capsules remain purely ICP-native
- No forced coupling to Web2 systems
- Maintains Web3 principles

### ✅ **Flexible User Experience**

- Google-only users: Web2 memories
- Google + II users: Both Web2 and Web3
- Seamless account linking

### ✅ **Future-Proof**

- Easy to add new authentication providers
- No migration complexity
- Scalable architecture

### ✅ **MVP Focus**

- Immediate implementation
- No backend changes required
- Focus on core functionality

---

## Migration Path

### Phase 1: Current State

- Google-only users: Web2 memories in Neon
- No ICP integration

### Phase 2: Add II Support

- Users can link Internet Identity
- Once linked, can create ICP capsules
- Memories can be stored in both systems

### Phase 3: Enhanced Integration

- Unified memory search across systems
- Storage preference management
- Advanced Web3 features

---

## Conclusion

We do **not** need a user–capsule mapping table in Neon. Capsules are tied to ICP principals, and that's sufficient. Our real challenge is ensuring **account linking in Auth.js works reliably**, so that a user's principals (Google, II, etc.) consistently map to the same Neon `userId`.

This simplifies our architecture, reduces unnecessary coupling, and keeps the Web3 system **independent** while still interoperable with Web2 through account linkage and memory storage.

---

**Prepared by:** Tech Lead  
**Date:** [Current Date]  
**Status:** ✅ **Approved for Implementation**

---
