# ngrok Integration Implementation

## Overview

This document outlines the implementation of ngrok integration for our Next.js application to enable external service callbacks and webhooks during development. This setup allows external services (like UploadThing, OAuth providers, etc.) to call our local development server.

## Problem Statement

When developing with external services that need to call back to our application (webhooks, OAuth callbacks, file upload completion notifications), localhost URLs are not accessible from the internet. This creates a development bottleneck where we can't test integrations that require public URLs.

## Solution: ngrok Integration

We implemented ngrok to tunnel our local development server to a public URL, enabling external services to reach our localhost application.

## Implementation Details

### 1. Package Configuration

**File:** `src/nextjs/package.json`

Added new scripts for ngrok integration:

```json
{
  "scripts": {
    "dev": "next dev --turbopack",
    "dev:ngrok": "ngrok http --url=theological-damion-unpatronizing.ngrok-free.app 3000",
    "dev:with-ngrok": "concurrently \"npm run dev\" \"npm run dev:ngrok\"",
    "setup-uploadthing": "node scripts/setup-uploadthing-dev.js",
    "setup-ngrok": "node scripts/setup-dev-ngrok.js"
  }
}
```

**Dependencies Added:**

- `concurrently` - Run multiple commands simultaneously

### 2. Environment Configuration Scripts

#### Primary Setup Script

**File:** `src/nextjs/scripts/setup-uploadthing-dev.js`

```javascript
#!/usr/bin/env node

const fs = require("fs");
const path = require("path");

console.log("üöÄ Setting up ngrok for your app development...\n");

// Check if developer has their own ngrok URL in environment
tonst customNgrokUrl = process.env.NEXT_PUBLIC_NGROK_URL;
const defaultNgrokUrl = "https://theological-damion-unpatronizing.ngrok-free.app";

const ngrokUrl = customNgrokUrl || defaultNgrokUrl;

// Create .env.local content
const envContent = `# ngrok configuration for development
NEXT_PUBLIC_NGROK_URL=${ngrokUrl}

# Development mode flag
NODE_ENV=development
`;

// Write .env.local file
const envPath = path.join(__dirname, "..", ".env.local");
fs.writeFileSync(envPath, envContent);

console.log("‚úÖ Created .env.local with ngrok configuration");
console.log(`üìù ngrok URL: ${ngrokUrl}`);
// ... additional setup instructions
```

#### Alternative Setup Script

**File:** `src/nextjs/scripts/setup-dev-ngrok.js`

Enhanced version with better developer guidance:

```javascript
#!/usr/bin/env node

const fs = require("fs");
const path = require("path");

console.log("üöÄ Setting up ngrok for development...\n");

// Check if developer has their own ngrok URL
const customNgrokUrl = process.env.NEXT_PUBLIC_NGROK_URL;
const defaultNgrokUrl = "https://theological-damion-unpatronizing.ngrok-free.app";

const ngrokUrl = customNgrokUrl || defaultNgrokUrl;

// Create .env.local content
const envContent = `# ngrok configuration for development
NEXT_PUBLIC_NGROK_URL=${ngrokUrl}

# Development mode flag
NODE_ENV=development
`;

// Write .env.local file
const envPath = path.join(__dirname, "..", ".env.local");
fs.writeFileSync(envPath, envContent);

if (customNgrokUrl) {
  console.log("üéØ Using your custom ngrok URL");
} else {
  console.log("‚ö†Ô∏è  Using shared ngrok URL (Stefano's)");
  console.log("üí° For your own setup:");
  console.log("   1. Sign up at https://ngrok.com");
  console.log("   2. Get your authtoken");
  console.log("   3. Run: ngrok config add-authtoken <your-token>");
  console.log("   4. Set: export NEXT_PUBLIC_NGROK_URL=https://your-domain.ngrok-free.app");
  console.log("   5. Run this script again");
}
```

### 3. Configuration Files

#### ngrok Configuration

**File:** `src/nextjs/ngrok.config.js`

```javascript
// ngrok configuration for UploadThing development
module.exports = {
  // Your static ngrok domain
  ngrokUrl: "https://theological-damion-unpatronizing.ngrok-free.app",

  // Environment variables to set
  env: {
    NEXT_PUBLIC_NGROK_URL: "https://theological-damion-unpatronizing.ngrok-free.app",
    NODE_ENV: "development",
  },
};
```

#### Environment Variables

**File:** `src/nextjs/.env.local` (Generated by setup scripts)

```bash
# ngrok configuration for development
NEXT_PUBLIC_NGROK_URL=https://theological-damion-unpatronizing.ngrok-free.app

# Development mode flag
NODE_ENV=development
```

### 4. Documentation

#### Developer Setup Guide

**File:** `src/nextjs/scripts/ngrok/README.md`

Comprehensive guide covering:

- Quick start with shared domain
- Individual developer setup
- Available scripts
- Troubleshooting
- Environment variables
- Use cases

#### UploadThing Integration Analysis

**File:** `docs/uploadthing-large-files-localhost.md`

Detailed analysis of how UploadThing handles large file uploads and the localhost callback issue, including:

- Presigned URL pattern explanation
- Localhost callback problems
- Multiple solution approaches
- Comparison with our current system

## File Structure

```
src/nextjs/
‚îú‚îÄ‚îÄ package.json                    # Updated with ngrok scripts
‚îú‚îÄ‚îÄ .env.local                      # Generated environment variables
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ ngrok/                      # ngrok scripts and configuration
‚îÇ       ‚îú‚îÄ‚îÄ README.md               # Comprehensive documentation
‚îÇ       ‚îú‚îÄ‚îÄ ngrok.config.js         # ngrok configuration
‚îÇ       ‚îú‚îÄ‚îÄ setup-uploadthing-dev.js # Primary setup script
‚îÇ       ‚îú‚îÄ‚îÄ setup-dev-ngrok.js      # Alternative setup script
‚îÇ       ‚îî‚îÄ‚îÄ setup-ngrok.js          # Original ngrok setup script

docs/
‚îú‚îÄ‚îÄ uploadthing-large-files-localhost.md  # UploadThing analysis
‚îú‚îÄ‚îÄ uploadthing-alternatives.md           # Alternative solutions
‚îî‚îÄ‚îÄ uploadthing-questions.md              # Research questions
```

## Usage Workflows

### For Stefano (Project Owner)

```bash
# Quick setup with shared domain
npm run setup-uploadthing
npm run dev:with-ngrok
```

### For Other Developers

```bash
# Option 1: Use shared domain (quick start)
npm run setup-uploadthing
npm run dev:with-ngrok

# Option 2: Individual setup (recommended)
# 1. Get own ngrok account and authtoken
ngrok config add-authtoken <their-token>
# 2. Get own domain
ngrok http 3000
# 3. Set environment
export NEXT_PUBLIC_NGROK_URL=https://abc123.ngrok-free.app
# 4. Run setup
npm run setup-ngrok
npm run dev:with-ngrok
```

## Technical Implementation

### ngrok Configuration

- **Static Domain:** `theological-damion-unpatronizing.ngrok-free.app`
- **Tunnel:** `https://theological-damion-unpatronizing.ngrok-free.app -> http://localhost:3000`
- **Web Interface:** `http://127.0.0.1:4040`

### Environment Variables

- `NEXT_PUBLIC_APP_URL` - Public ngrok URL for external callbacks
- `NODE_ENV=development` - Development mode flag

### Scripts Integration

- `concurrently` package runs Next.js and ngrok simultaneously
- Setup scripts automatically configure environment variables
- Flexible configuration supports both shared and individual domains

## Benefits

### Development Benefits

- ‚úÖ **External Service Integration** - Webhooks and callbacks work in development
- ‚úÖ **OAuth Testing** - Social login redirects function properly
- ‚úÖ **File Upload Testing** - Services like UploadThing can notify completion
- ‚úÖ **API Testing** - External services can call our endpoints

### Team Benefits

- ‚úÖ **Flexible Setup** - Each developer can use shared or individual domains
- ‚úÖ **Easy Onboarding** - Simple scripts for quick setup
- ‚úÖ **Documentation** - Comprehensive guides for different scenarios
- ‚úÖ **No Conflicts** - Individual domains prevent developer conflicts

## Use Cases Enabled

1. **UploadThing Integration** - File upload completion callbacks
2. **OAuth Providers** - Social login redirects
3. **Webhook Testing** - External service notifications
4. **API Integration** - Services requiring public URLs
5. **Payment Processing** - Payment gateway callbacks
6. **Third-party Services** - Any service needing to call back to our app

## Future Considerations

### Scalability

- Consider upgrading to ngrok paid plan for team features
- Implement domain rotation for multiple developers
- Add monitoring for ngrok tunnel health

### Security

- Implement webhook signature verification
- Add rate limiting for public endpoints
- Consider IP whitelisting for development

### Automation

- Add CI/CD integration for testing with ngrok
- Implement automatic tunnel health checks
- Add environment-specific configurations

## Conclusion

The ngrok integration provides a robust solution for external service integration during development. The implementation is flexible, well-documented, and supports both individual and team development workflows. This setup enables testing of integrations that require public URLs while maintaining the convenience of local development.
